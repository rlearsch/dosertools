
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>dosertools.image_processing.tiff_handling &#8212; dosertools 2022 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for dosertools.image_processing.tiff_handling</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">typing</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">import</span> <span class="nn">skimage.filters</span>
<span class="kn">import</span> <span class="nn">skimage.io</span>
<span class="kn">import</span> <span class="nn">skimage.morphology</span>
<span class="kn">from</span> <span class="nn">skimage.filters</span> <span class="kn">import</span> <span class="p">(</span><span class="n">threshold_otsu</span><span class="p">,</span> <span class="n">threshold_mean</span><span class="p">,</span> <span class="n">threshold_li</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">skimage</span> <span class="kn">import</span> <span class="n">exposure</span>

<span class="kn">from</span> <span class="nn">..data_processing</span> <span class="kn">import</span> <span class="n">array</span> <span class="k">as</span> <span class="n">dparray</span>
<span class="kn">from</span> <span class="nn">..data_processing</span> <span class="kn">import</span> <span class="n">integration</span> <span class="k">as</span> <span class="n">integration</span>
<span class="kn">from</span> <span class="nn">..file_handling</span> <span class="kn">import</span> <span class="n">folder</span> <span class="k">as</span> <span class="n">folder</span>

<div class="viewcode-block" id="define_image_parameters"><a class="viewcode-back" href="../../../dostools.image_processing.html#dosertools.image_processing.tiff_handling.define_image_parameters">[docs]</a><span class="k">def</span> <span class="nf">define_image_parameters</span><span class="p">(</span><span class="n">video</span><span class="p">:</span> <span class="n">skimage</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">,</span> <span class="n">optional_settings</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{})</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    From the given video, determines the first-guess for the cropping operation.</span>

<span class="sd">    Based on the nozzle width and safety factors crop_width_coefficient, crop_height_coefficient, etc.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    video: skimage.io.collection.ImageCollection</span>
<span class="sd">         The video containing a clear image of the nozzle, we default to the raw experimental video</span>
<span class="sd">    optional_settings: dict</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    params_dict: dict</span>
<span class="sd">        Dictionary of parameters with the crop information added</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">settings</span> <span class="o">=</span> <span class="n">integration</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">optional_settings</span><span class="p">)</span>

    <span class="n">nozzle_row</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;nozzle_row&quot;</span><span class="p">]</span>
    <span class="n">crop_width_coefficient</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;crop_width_coefficient&quot;</span><span class="p">]</span>
    <span class="n">crop_nozzle_coefficient</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;crop_nozzle_coefficient&quot;</span><span class="p">]</span>
    <span class="n">crop_height_coefficient</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;crop_height_coefficient&quot;</span><span class="p">]</span>

    <span class="n">first_frame</span> <span class="o">=</span> <span class="n">video</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">first_frame</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">first_frame</span> <span class="o">=</span> <span class="n">skimage</span><span class="o">.</span><span class="n">color</span><span class="o">.</span><span class="n">rgb2gray</span><span class="p">(</span><span class="n">first_frame</span><span class="p">)</span>
    <span class="n">thresh_otsu</span> <span class="o">=</span> <span class="n">threshold_otsu</span><span class="p">(</span><span class="n">first_frame</span><span class="p">)</span>
    <span class="n">binary_otsu</span> <span class="o">=</span> <span class="n">first_frame</span> <span class="o">&lt;</span> <span class="n">thresh_otsu</span>
    <span class="n">binary_otsu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">binary_otsu</span><span class="p">)</span><span class="o">*</span><span class="mi">255</span>
    <span class="n">binary_otsu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="n">binary_otsu</span><span class="p">)</span>

    <span class="c1"># Crop down to nozzle:</span>
    <span class="c1">## width = nozzle + 2%</span>
    <span class="c1">## height = nozzle * 2.5</span>
    <span class="n">non_zero_indicies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">binary_otsu</span><span class="p">[</span><span class="n">nozzle_row</span><span class="p">,:])</span>
    <span class="n">first_non_zero</span> <span class="o">=</span> <span class="n">non_zero_indicies</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">last_non_zero</span> <span class="o">=</span> <span class="n">non_zero_indicies</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">nozzle_diameter</span> <span class="o">=</span> <span class="n">last_non_zero</span> <span class="o">-</span> <span class="n">first_non_zero</span> <span class="o">+</span> <span class="mi">1</span> <span class="c1">#pix</span>

    <span class="n">crop_width_start</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">first_non_zero</span><span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">nozzle_diameter</span><span class="o">*</span><span class="n">crop_width_coefficient</span><span class="p">))</span>
    <span class="n">crop_width_end</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">last_non_zero</span><span class="o">+</span><span class="nb">int</span><span class="p">(</span><span class="n">nozzle_diameter</span><span class="o">*</span><span class="n">crop_width_coefficient</span><span class="p">))</span>
    <span class="n">crop_bottom</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nozzle_diameter</span><span class="o">*</span><span class="n">crop_height_coefficient</span><span class="p">)</span>
    <span class="n">crop_top</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nozzle_diameter</span><span class="o">*</span><span class="n">crop_nozzle_coefficient</span><span class="p">)</span>

    <span class="n">params_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">params_dict</span><span class="p">[</span><span class="s2">&quot;crop_width_start&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">crop_width_start</span>
    <span class="n">params_dict</span><span class="p">[</span><span class="s2">&quot;crop_width_end&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">crop_width_end</span>
    <span class="n">params_dict</span><span class="p">[</span><span class="s2">&quot;crop_bottom&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">crop_bottom</span>
    <span class="n">params_dict</span><span class="p">[</span><span class="s2">&quot;crop_top&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">crop_top</span>
    <span class="n">params_dict</span><span class="p">[</span><span class="s2">&quot;nozzle_diameter&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nozzle_diameter</span>

    <span class="k">return</span> <span class="n">params_dict</span></div>

<div class="viewcode-block" id="save_image"><a class="viewcode-back" href="../../../dostools.image_processing.html#dosertools.image_processing.tiff_handling.save_image">[docs]</a><span class="k">def</span> <span class="nf">save_image</span><span class="p">(</span><span class="n">image</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">image_number</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">save_location</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">],</span> <span class="n">extension</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Saves a single image to the hard drive in save_location</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    image: np.ndarray</span>
<span class="sd">        The image to save</span>
<span class="sd">    image_number: int</span>
<span class="sd">        Part of the filename. The frame number of this particular image in the video</span>
<span class="sd">    save_location: path-like</span>
<span class="sd">        The folder where file should be saved</span>
<span class="sd">    extension: str</span>
<span class="sd">        The file extension, eg, .tiff, .png</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Image saved on the hard drive at save_location</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">image_number</span><span class="si">:</span><span class="s2">03</span><span class="si">}</span><span class="s2">.&quot;</span><span class="o">+</span><span class="n">extension</span>
    <span class="n">full_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_location</span><span class="p">,</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">skimage</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">imsave</span><span class="p">(</span><span class="n">full_filename</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">check_contrast</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">pass</span></div>

<div class="viewcode-block" id="convert_tiff_image"><a class="viewcode-back" href="../../../dostools.image_processing.html#dosertools.image_processing.tiff_handling.convert_tiff_image">[docs]</a><span class="k">def</span> <span class="nf">convert_tiff_image</span><span class="p">(</span><span class="n">image</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">bg_median</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">params_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">image_number</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">images_location</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">],</span> <span class="n">folders_exist</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span><span class="nb">bool</span><span class="p">,</span><span class="nb">bool</span><span class="p">],</span> <span class="n">optional_settings</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{})</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fully converts a raw tiff to binary png image.</span>

<span class="sd">    Crops, perforns background subtraction, and binarizies. Always saves the</span>
<span class="sd">    binarized image as a .png, optional to save the intermediate steps.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    image: np.ndarray</span>
<span class="sd">        The image to convert and save</span>
<span class="sd">    bg_median: np.ndarray</span>
<span class="sd">        The single background image produced from produce_background_image</span>
<span class="sd">    params_dict: dict</span>
<span class="sd">        Dictionary of parameters with the crop information added</span>
<span class="sd">    images_location: path-like</span>
<span class="sd">        The folder where file should be saved</span>
<span class="sd">    folders_exist: Tuple of three bools</span>
<span class="sd">        Booleans indicating whether the binary, crop, and bg_sub folders</span>
<span class="sd">        already existed to allow convert_tiff_image image to skip the relevant</span>
<span class="sd">        saves if optional_settings has skip_existing = True</span>
<span class="sd">    optional_settings: dict</span>
<span class="sd">        A dictionary of optional settings.</span>

<span class="sd">    Optional Settings and Defaults</span>
<span class="sd">    ------------------------------</span>
<span class="sd">    save_crop: bool</span>
<span class="sd">        True to save intermediate cropped images (i.e. experimental video</span>
<span class="sd">        images cropped but not background-subtracted or binarized).</span>
<span class="sd">        Default is False.</span>
<span class="sd">    save_bg_sub: bool</span>
<span class="sd">        True to save background-subtracted images (i.e. experimental video</span>
<span class="sd">        images cropped and background-subtracted but not binarized).</span>
<span class="sd">        Default is False.</span>
<span class="sd">    skip_existing: bool</span>
<span class="sd">        Determines the behavior when a file already appears exists</span>
<span class="sd">        when a function would generate it. True to skip any existing files.</span>
<span class="sd">        False to overwrite (or delete and then write, where overwriting would</span>
<span class="sd">        generate an error).</span>
<span class="sd">        Default is True.</span>

<span class="sd">    Returns</span>
<span class="sd">    ------</span>
<span class="sd">    Image sequence (video) saved on the hard drive at save_location</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">settings</span> <span class="o">=</span> <span class="n">integration</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">optional_settings</span><span class="p">)</span>
    <span class="n">save_crop</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;save_crop&quot;</span><span class="p">]</span>
    <span class="n">save_bg_sub</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;save_bg_sub&quot;</span><span class="p">]</span>
    <span class="n">skip_existing</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;skip_existing&quot;</span><span class="p">]</span>
    <span class="p">[</span><span class="n">bin_exists</span><span class="p">,</span> <span class="n">crop_exists</span><span class="p">,</span> <span class="n">bg_sub_exists</span><span class="p">]</span> <span class="o">=</span> <span class="n">folders_exist</span>

    <span class="n">image</span> <span class="o">=</span> <span class="n">exposure</span><span class="o">.</span><span class="n">rescale_intensity</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">in_range</span><span class="o">=</span><span class="s1">&#39;uint12&#39;</span><span class="p">,</span> <span class="n">out_range</span><span class="o">=</span><span class="s1">&#39;uint16&#39;</span><span class="p">)</span>
    <span class="n">cropped_image</span> <span class="o">=</span> <span class="n">crop_single_image</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">params_dict</span><span class="p">,</span> <span class="n">optional_settings</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">save_crop</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">crop_exists</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">skip_existing</span><span class="p">:</span>
            <span class="n">save_image</span><span class="p">(</span><span class="n">cropped_image</span><span class="p">,</span> <span class="n">image_number</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">images_location</span><span class="p">,</span><span class="s2">&quot;crop&quot;</span><span class="p">),</span><span class="s2">&quot;tiff&quot;</span><span class="p">)</span>
    <span class="n">background_subtracted_image</span> <span class="o">=</span> <span class="n">subtract_background_single_image</span><span class="p">(</span><span class="n">cropped_image</span><span class="p">,</span> <span class="n">bg_median</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">save_bg_sub</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">bg_sub_exists</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">skip_existing</span><span class="p">:</span>
            <span class="n">save_image</span><span class="p">(</span><span class="n">background_subtracted_image</span><span class="p">,</span> <span class="n">image_number</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">images_location</span><span class="p">,</span><span class="s2">&quot;bg_sub&quot;</span><span class="p">),</span> <span class="s2">&quot;tiff&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">bin_exists</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">skip_existing</span><span class="p">:</span>
        <span class="n">binary_image</span> <span class="o">=</span> <span class="n">mean_binarize_single_image</span><span class="p">(</span><span class="n">background_subtracted_image</span><span class="p">)</span>
        <span class="n">save_image</span><span class="p">(</span><span class="n">binary_image</span><span class="p">,</span> <span class="n">image_number</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">images_location</span><span class="p">,</span><span class="s2">&quot;bin&quot;</span><span class="p">),</span><span class="s2">&quot;png&quot;</span><span class="p">)</span>
    <span class="k">pass</span></div>

<div class="viewcode-block" id="produce_background_image"><a class="viewcode-back" href="../../../dostools.image_processing.html#dosertools.image_processing.tiff_handling.produce_background_image">[docs]</a><span class="k">def</span> <span class="nf">produce_background_image</span><span class="p">(</span><span class="n">background_video</span><span class="p">:</span> <span class="n">skimage</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">,</span> <span class="n">params_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">optional_settings</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{})</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Produces the background image from which the experimental video will be subtracted.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    background_video: skimage.io.collection.ImageCollection</span>
<span class="sd">         The video identified as the background video from the researcher</span>
<span class="sd">    params_dict: dict</span>
<span class="sd">        Dictionary of parameters with the crop information added</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bg_median: np.ndarray</span>
<span class="sd">        The median of the frames in the background.</span>
<span class="sd">        We prefer median because it is less sensitive to random noise and the values are likely to be integers</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">settings</span> <span class="o">=</span> <span class="n">integration</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">optional_settings</span><span class="p">)</span>
    <span class="n">nozzle_row</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;nozzle_row&quot;</span><span class="p">]</span>
    <span class="n">crop_width_start</span> <span class="o">=</span> <span class="n">params_dict</span><span class="p">[</span><span class="s2">&quot;crop_width_start&quot;</span><span class="p">]</span>
    <span class="n">crop_width_end</span> <span class="o">=</span> <span class="n">params_dict</span><span class="p">[</span><span class="s2">&quot;crop_width_end&quot;</span><span class="p">]</span>
    <span class="n">crop_bottom</span> <span class="o">=</span> <span class="n">params_dict</span><span class="p">[</span><span class="s2">&quot;crop_bottom&quot;</span><span class="p">]</span>
    <span class="n">crop_top</span> <span class="o">=</span> <span class="n">params_dict</span><span class="p">[</span><span class="s2">&quot;crop_top&quot;</span><span class="p">]</span>

    <span class="n">bg_median</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">background_video</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">bg_median</span> <span class="o">=</span> <span class="n">exposure</span><span class="o">.</span><span class="n">rescale_intensity</span><span class="p">(</span><span class="n">bg_median</span><span class="p">,</span> <span class="n">in_range</span><span class="o">=</span><span class="s1">&#39;uint12&#39;</span><span class="p">,</span> <span class="n">out_range</span><span class="o">=</span><span class="s1">&#39;uint16&#39;</span><span class="p">)</span>
    <span class="n">bg_median</span> <span class="o">=</span> <span class="n">bg_median</span><span class="p">[</span><span class="n">nozzle_row</span><span class="o">+</span><span class="n">crop_top</span><span class="p">:</span><span class="n">crop_bottom</span><span class="o">+</span><span class="n">crop_top</span><span class="p">,</span> <span class="n">crop_width_start</span><span class="p">:</span><span class="n">crop_width_end</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">bg_median</span></div>

<div class="viewcode-block" id="remove_bg_drop"><a class="viewcode-back" href="../../../dostools.image_processing.html#dosertools.image_processing.tiff_handling.remove_bg_drop">[docs]</a><span class="k">def</span> <span class="nf">remove_bg_drop</span><span class="p">(</span><span class="n">bg_median</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Removes the background drop on the substrate from the background image.</span>

<span class="sd">    Using the edge from bg_drop_top_edge, replaces all pixels at or below it</span>
<span class="sd">    with the maximum in the background.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    bg_median: np.ndarray</span>
<span class="sd">        median of the background video from produce_background_image</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bg_new: np.ndarray</span>
<span class="sd">        bg_median with the drop at the bottom set to the maximum value</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Creates a duplicate of the background</span>
    <span class="n">bg_new</span> <span class="o">=</span> <span class="n">bg_median</span>

    <span class="c1"># Finds the maximum of the bg_median array</span>
    <span class="c1">#max_value = np.iinfo(bg_median.dtype).max</span>
    <span class="n">max_value</span> <span class="o">=</span> <span class="n">bg_median</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="c1"># Selects pixels below the top of the background drop that are in the drop</span>
    <span class="c1"># based on edge detection and sets those pixels to the maximum available</span>
    <span class="c1"># for the background</span>
    <span class="n">top_edge</span> <span class="o">=</span> <span class="n">bg_drop_top_edge</span><span class="p">(</span><span class="n">bg_median</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">bg_new</span><span class="p">)[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">bg_new</span><span class="p">)[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">top_edge</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                <span class="n">bg_new</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_value</span>

    <span class="c1"># Returns the bg_median with the drop set to max</span>
    <span class="k">return</span> <span class="n">bg_new</span></div>

<div class="viewcode-block" id="bg_drop_top_edge"><a class="viewcode-back" href="../../../dostools.image_processing.html#dosertools.image_processing.tiff_handling.bg_drop_top_edge">[docs]</a><span class="k">def</span> <span class="nf">bg_drop_top_edge</span><span class="p">(</span><span class="n">bg_median</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determines the top edge of the background drop on the substrate.</span>

<span class="sd">    Detects the lowest edge in the background image. Uses Sobel edge detection.</span>


<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    bg_median: np.ndarray</span>
<span class="sd">        median of the background video from produce_background_image</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bg_drop_top_edge: list</span>
<span class="sd">        list of pixel y-values for the top edge of the background</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Finds edges in the background image using the Sobel edge detection method</span>
    <span class="n">edge_sobel</span> <span class="o">=</span> <span class="n">skimage</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">sobel</span><span class="p">(</span><span class="n">bg_median</span><span class="p">)</span>
    <span class="n">sobel_otsu</span> <span class="o">=</span> <span class="n">skimage</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">threshold_otsu</span><span class="p">(</span><span class="n">edge_sobel</span><span class="p">)</span>
    <span class="n">binary_sobel</span> <span class="o">=</span> <span class="p">(</span><span class="n">edge_sobel</span> <span class="o">&lt;</span> <span class="n">sobel_otsu</span><span class="p">)</span><span class="o">*</span><span class="mi">1</span>
    <span class="c1"># binary sobel: edge = 0, nonedge = 1</span>

    <span class="n">height</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">bg_median</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">bg_drop_top_edge</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">binary_sobel</span><span class="p">)[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">edge</span> <span class="o">=</span> <span class="n">dparray</span><span class="o">.</span><span class="n">continuous_zero</span><span class="p">(</span><span class="n">binary_sobel</span><span class="p">[:,</span><span class="n">i</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">edge</span><span class="p">):</span>
            <span class="c1"># Returns top pixel of bottom edge if there is an edge detected</span>
            <span class="n">bg_drop_top_edge</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edge</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Returns the bottom pixel if no edge exists</span>
            <span class="n">bg_drop_top_edge</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">height</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">bg_drop_top_edge</span></div>

<div class="viewcode-block" id="convert_tiff_sequence_to_binary"><a class="viewcode-back" href="../../../dostools.image_processing.html#dosertools.image_processing.tiff_handling.convert_tiff_sequence_to_binary">[docs]</a><span class="k">def</span> <span class="nf">convert_tiff_sequence_to_binary</span><span class="p">(</span><span class="n">experimental_video</span><span class="p">:</span> <span class="n">skimage</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">,</span> <span class="n">bg_median</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">params_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">save_location</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">],</span> <span class="n">folders_exist</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span><span class="nb">bool</span><span class="p">,</span><span class="nb">bool</span><span class="p">],</span> <span class="n">optional_settings</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Takes as arguments the skimage image sequence holding the experimental video and the background image to subtract.</span>

<span class="sd">    Performs, sequentially, cropping, background subtraction, and binarization by the Mean method, and saves the binary images.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    experimental_video: skimage.io.collection.ImageCollection</span>
<span class="sd">         The video identified as the experiment video from the researcher</span>
<span class="sd">    bg_median: np.ndarray</span>
<span class="sd">        The single background image produced from produce_background_image</span>
<span class="sd">    params_dict: dict</span>
<span class="sd">        Dictionary of parameters with the crop information added</span>
<span class="sd">    save_location: path-like</span>
<span class="sd">        The folder where file should be saved</span>
<span class="sd">    folders_exist: Tuple of three bools</span>
<span class="sd">        Booleans indicating whether the binary, crop, and bg_sub folders</span>
<span class="sd">        already existed to allow convert_tiff_image image to skip the relevant</span>
<span class="sd">        saves if optional_settings has skip_existing = True</span>
<span class="sd">    optional_settings: dict</span>
<span class="sd">        A dictionary of optional settings.</span>

<span class="sd">    Optional Settings and Defaults</span>
<span class="sd">    ------------------------------</span>
<span class="sd">    save_crop: bool</span>
<span class="sd">        True to save intermediate cropped images (i.e. experimental video</span>
<span class="sd">        images cropped but not background-subtracted or binarized).</span>
<span class="sd">        Default is False.</span>
<span class="sd">    save_bg_sub: bool</span>
<span class="sd">        True to save background-subtracted images (i.e. experimental video</span>
<span class="sd">        images cropped and background-subtracted but not binarized).</span>
<span class="sd">        Default is False.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Image(s) saved locally in save_location</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">for</span> <span class="n">image_number</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">experimental_video</span><span class="p">)):</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">experimental_video</span><span class="p">[</span><span class="n">image_number</span><span class="p">]</span>
        <span class="n">convert_tiff_image</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">bg_median</span><span class="p">,</span> <span class="n">params_dict</span><span class="p">,</span> <span class="n">image_number</span><span class="p">,</span> <span class="n">save_location</span><span class="p">,</span> <span class="n">folders_exist</span><span class="p">,</span> <span class="n">optional_settings</span><span class="p">)</span>
    <span class="k">pass</span></div>

<div class="viewcode-block" id="crop_single_image"><a class="viewcode-back" href="../../../dostools.image_processing.html#dosertools.image_processing.tiff_handling.crop_single_image">[docs]</a><span class="k">def</span> <span class="nf">crop_single_image</span><span class="p">(</span><span class="n">image</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">params_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span><span class="n">optional_settings</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{})</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Crops a single image according to parameters from params_dict</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    image: np.ndarray (scikit.io.imread)</span>
<span class="sd">         The video identified as the experiment video from the researcher</span>
<span class="sd">    params_dict: dict</span>
<span class="sd">        Dictionary of parameters with the crop information added</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    cropped_image: np.ndarray</span>
<span class="sd">        The input image, cropped according to values in parameters dictionary</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">settings</span> <span class="o">=</span> <span class="n">integration</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">optional_settings</span><span class="p">)</span>
    <span class="n">nozzle_row</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;nozzle_row&quot;</span><span class="p">]</span>
    <span class="n">crop_width_start</span> <span class="o">=</span> <span class="n">params_dict</span><span class="p">[</span><span class="s2">&quot;crop_width_start&quot;</span><span class="p">]</span>
    <span class="n">crop_width_end</span> <span class="o">=</span> <span class="n">params_dict</span><span class="p">[</span><span class="s2">&quot;crop_width_end&quot;</span><span class="p">]</span>
    <span class="n">crop_bottom</span> <span class="o">=</span> <span class="n">params_dict</span><span class="p">[</span><span class="s2">&quot;crop_bottom&quot;</span><span class="p">]</span>
    <span class="n">crop_top</span> <span class="o">=</span> <span class="n">params_dict</span><span class="p">[</span><span class="s2">&quot;crop_top&quot;</span><span class="p">]</span>

    <span class="n">cropped_image</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="n">nozzle_row</span><span class="o">+</span><span class="n">crop_top</span><span class="p">:</span><span class="n">crop_bottom</span><span class="o">+</span><span class="n">crop_top</span><span class="p">,</span> <span class="n">crop_width_start</span><span class="p">:</span><span class="n">crop_width_end</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">cropped_image</span></div>

<div class="viewcode-block" id="subtract_background_single_image"><a class="viewcode-back" href="../../../dostools.image_processing.html#dosertools.image_processing.tiff_handling.subtract_background_single_image">[docs]</a><span class="k">def</span> <span class="nf">subtract_background_single_image</span><span class="p">(</span><span class="n">cropped_image</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">bg_median</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Performs background subtraction from a cropped image.</span>

<span class="sd">    Assumes cropped_image and bg_median are the same size.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cropped_image: np.ndarray</span>
<span class="sd">        The initial image, cropped according to values in parameters dictionary</span>
<span class="sd">    bg_median: np.ndarray</span>
<span class="sd">        The single background image produced from produce_background_image</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    background_subtracted_image: np.ndarray</span>
<span class="sd">        The cropped image with the background subtraction performed</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">background_subtracted_image_org</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">cropped_image</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">bg_median</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">background_subtracted_image_org</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="c1">#this means image is darker than background</span>
        <span class="n">background_subtracted_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">background_subtracted_image_org</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="n">background_subtracted_image_org</span><span class="p">)</span>
        <span class="n">background_subtracted_image</span> <span class="o">=</span> <span class="n">background_subtracted_image</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">background_subtracted_image</span><span class="p">)</span>
        <span class="c1">#eliminates half the noise</span>
        <span class="n">background_subtracted_image</span> <span class="o">=</span> <span class="n">skimage</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">background_subtracted_image</span><span class="p">)</span>
        <span class="n">background_subtracted_image</span> <span class="o">=</span> <span class="n">skimage</span><span class="o">.</span><span class="n">img_as_uint</span><span class="p">(</span><span class="n">background_subtracted_image</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">background_subtracted_image_org</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="c1"># this means that background is darker than image:</span>
        <span class="n">background_subtracted_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">background_subtracted_image_org</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="n">background_subtracted_image_org</span><span class="p">)</span>
        <span class="n">background_subtracted_image</span> <span class="o">=</span> <span class="n">background_subtracted_image</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">background_subtracted_image</span><span class="p">)</span>
        <span class="n">background_subtracted_image</span> <span class="o">=</span> <span class="n">skimage</span><span class="o">.</span><span class="n">img_as_uint</span><span class="p">(</span><span class="n">background_subtracted_image</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">background_subtracted_image</span></div>

<div class="viewcode-block" id="mean_binarize_single_image"><a class="viewcode-back" href="../../../dostools.image_processing.html#dosertools.image_processing.tiff_handling.mean_binarize_single_image">[docs]</a><span class="k">def</span> <span class="nf">mean_binarize_single_image</span><span class="p">(</span><span class="n">background_subtracted_image</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Performs global binarization on an image according to the Otsu method</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    background_subtracted_image: np.ndarray</span>
<span class="sd">        The cropped image with the background subtraction performed</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    binary_otsu: np.ndarray</span>
<span class="sd">        The binarized version of the input image</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#thresh_mean = threshold_mean(background_subtracted_image)</span>
    <span class="n">thresh_otsu</span> <span class="o">=</span> <span class="n">threshold_otsu</span><span class="p">(</span><span class="n">background_subtracted_image</span><span class="p">)</span>
    <span class="n">binary_otsu</span> <span class="o">=</span> <span class="n">background_subtracted_image</span> <span class="o">&lt;</span> <span class="n">thresh_otsu</span>
    <span class="n">binary_otsu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">binary_otsu</span><span class="p">)</span><span class="o">*</span><span class="mi">255</span>
    <span class="n">binary_otsu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="n">binary_otsu</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">binary_otsu</span></div>

<div class="viewcode-block" id="tiffs_to_binary"><a class="viewcode-back" href="../../../dostools.image_processing.html#dosertools.image_processing.tiff_handling.tiffs_to_binary">[docs]</a><span class="k">def</span> <span class="nf">tiffs_to_binary</span><span class="p">(</span><span class="n">experimental_video_folder</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">],</span> <span class="n">background_video_folder</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">],</span> <span class="n">images_location</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">],</span> <span class="n">optional_settings</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Processes experimental and background video into binarized video.</span>

<span class="sd">    Given a experimental video folder and a background video folder, processes</span>
<span class="sd">    the videos into a folder of binarized images in the target directory.</span>
<span class="sd">    Can also produce cropped and background subtracted images given optional</span>
<span class="sd">    settings.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    experimental_video_folder: path-like</span>
<span class="sd">        Points to the folder which contains the experimental video to analyse.</span>
<span class="sd">    background_video_folder: path-like</span>
<span class="sd">        Points to the folder which contains the background video used in analysis.</span>
<span class="sd">    images_location: path-like</span>
<span class="sd">        The folder where folders of images should be saved.</span>
<span class="sd">    optional_settings: dict</span>
<span class="sd">        A dictionary of optional settings.</span>

<span class="sd">    Optional Settings and Defaults</span>
<span class="sd">    ------------------------------</span>
<span class="sd">    save_crop: bool</span>
<span class="sd">        True to save intermediate cropped images (i.e. experimental video</span>
<span class="sd">        images cropped but not background-subtracted or binarized).</span>
<span class="sd">        Default is False.</span>
<span class="sd">    save_bg_sub: bool</span>
<span class="sd">        True to save background-subtracted images (i.e. experimental video</span>
<span class="sd">        images cropped and background-subtracted but not binarized).</span>
<span class="sd">        Default is False.</span>
<span class="sd">    bg_drop_removal: bool</span>
<span class="sd">        True to remove the background drop from the background that is</span>
<span class="sd">        subtracted from the image before binarization. False to not alter</span>
<span class="sd">        the background.</span>
<span class="sd">        Default is False.</span>
<span class="sd">    skip_existing: bool</span>
<span class="sd">        Determines the behavior when a file already appears exists</span>
<span class="sd">        when a function would generate it. True to skip any existing files.</span>
<span class="sd">        False to overwrite (or delete and then write, where overwriting would</span>
<span class="sd">        generate an error).</span>
<span class="sd">        Default is True.</span>
<span class="sd">    verbose: bool</span>
<span class="sd">        Determines whether processing functions print statements as they</span>
<span class="sd">        progress through major steps. True to see print statements, False to</span>
<span class="sd">        hide non-errors/warnings.</span>
<span class="sd">        Default is False.</span>
<span class="sd">    image_extension: string</span>
<span class="sd">        The extension for images in the video folder. TIFF recommended.</span>
<span class="sd">        Default is &quot;tif&quot;. Do not include &quot;.&quot;.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Image sequence(s) (video) saved on the hard drive at images_location</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">settings</span> <span class="o">=</span> <span class="n">integration</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">optional_settings</span><span class="p">)</span>
    <span class="n">skip_existing</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;skip_existing&quot;</span><span class="p">]</span>
    <span class="n">image_extension</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;image_extension&quot;</span><span class="p">]</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">]</span>
    <span class="n">bg_drop_removal</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;bg_drop_removal&quot;</span><span class="p">]</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">experimental_video_folder</span><span class="p">)</span>

    <span class="n">folders_exist</span> <span class="o">=</span> <span class="n">folder</span><span class="o">.</span><span class="n">make_destination_folders</span><span class="p">(</span><span class="n">images_location</span><span class="p">,</span> <span class="n">optional_settings</span><span class="p">)</span>
    <span class="c1"># If all the image folders that would be saved exist and the skip_existing</span>
    <span class="c1"># is True, skips loading and saving images completely.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">folders_exist</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">skip_existing</span><span class="p">:</span>
        <span class="c1"># TODO: test image format handling</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Processing folder: &quot;</span> <span class="o">+</span> <span class="n">fname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">image_extension</span> <span class="o">==</span> <span class="s2">&quot;tif&quot;</span> <span class="ow">or</span> <span class="n">image_extension</span> <span class="o">==</span> <span class="s2">&quot;tiff&quot;</span><span class="p">:</span>
            <span class="n">experimental_video</span> <span class="o">=</span> <span class="n">skimage</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">imread_collection</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">experimental_video_folder</span><span class="p">,</span><span class="s2">&quot;*.&quot;</span> <span class="o">+</span> <span class="n">image_extension</span><span class="p">),</span> <span class="n">plugin</span><span class="o">=</span><span class="s1">&#39;tifffile&#39;</span><span class="p">)</span>
            <span class="n">background_video</span> <span class="o">=</span> <span class="n">skimage</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">imread_collection</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">background_video_folder</span><span class="p">,</span><span class="s2">&quot;*.&quot;</span><span class="o">+</span><span class="n">image_extension</span><span class="p">),</span> <span class="n">plugin</span><span class="o">=</span><span class="s1">&#39;tifffile&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># No plugin used for non-TIFF image formats</span>
            <span class="n">experimental_video</span> <span class="o">=</span> <span class="n">skimage</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">imread_collection</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">experimental_video_folder</span><span class="p">,</span><span class="s2">&quot;*.&quot;</span> <span class="o">+</span> <span class="n">image_extension</span><span class="p">))</span>
            <span class="n">background_video</span> <span class="o">=</span> <span class="n">skimage</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">imread_collection</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">background_video_folder</span><span class="p">,</span><span class="s2">&quot;*.&quot;</span> <span class="o">+</span> <span class="n">image_extension</span><span class="p">))</span>
        <span class="n">params_dict</span> <span class="o">=</span> <span class="n">define_image_parameters</span><span class="p">(</span><span class="n">experimental_video</span><span class="p">,</span> <span class="n">optional_settings</span><span class="p">)</span>
        <span class="n">bg_median</span> <span class="o">=</span> <span class="n">produce_background_image</span><span class="p">(</span><span class="n">background_video</span><span class="p">,</span> <span class="n">params_dict</span><span class="p">,</span> <span class="n">optional_settings</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bg_drop_removal</span><span class="p">:</span>
            <span class="n">bg_median</span> <span class="o">=</span> <span class="n">remove_bg_drop</span><span class="p">(</span><span class="n">bg_median</span><span class="p">)</span>
        <span class="n">convert_tiff_sequence_to_binary</span><span class="p">(</span><span class="n">experimental_video</span><span class="p">,</span> <span class="n">bg_median</span><span class="p">,</span> <span class="n">params_dict</span><span class="p">,</span> <span class="n">images_location</span><span class="p">,</span> <span class="n">folders_exist</span><span class="p">,</span> <span class="n">optional_settings</span><span class="p">)</span>
        <span class="n">params_dict</span><span class="p">[</span><span class="s2">&quot;window_top&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">top_border</span><span class="p">(</span><span class="n">bg_median</span><span class="p">)</span>
        <span class="n">export_params</span><span class="p">(</span><span class="n">images_location</span><span class="p">,</span> <span class="n">params_dict</span><span class="p">)</span>
        <span class="n">toc</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="c1">#if verbose:</span>
        <span class="c1">#    print(&quot;Total time elapsed: &quot; + str(np.round((toc-tic))) + &quot; seconds&quot;)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Folder &quot;</span> <span class="o">+</span> <span class="n">fname</span> <span class="o">+</span> <span class="s2">&quot;skipped because all folders for processing already exist and optional_settings skip_existing is True (by default).&quot;</span><span class="p">)</span>
    <span class="k">pass</span></div>

<div class="viewcode-block" id="top_border"><a class="viewcode-back" href="../../../dostools.image_processing.html#dosertools.image_processing.tiff_handling.top_border">[docs]</a><span class="k">def</span> <span class="nf">top_border</span><span class="p">(</span><span class="n">bg_median</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Finds the top border of interest given a background image.</span>

<span class="sd">    Finds the last row of the nozzle in the background image to use as the top</span>
<span class="sd">    border in further image analysis.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    bg_median: np.ndarray</span>
<span class="sd">        Background image corresponding to a particular run.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    top_border: int</span>
<span class="sd">        Last row of the nozzle.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Convert the background image to binary.</span>
    <span class="n">bg_binary</span> <span class="o">=</span> <span class="mi">255</span> <span class="o">*</span> <span class="p">(</span><span class="n">bg_median</span> <span class="o">&lt;</span> <span class="n">threshold_otsu</span><span class="p">(</span><span class="n">bg_median</span><span class="p">))</span>


    <span class="c1"># Find last row of the needle.</span>
    <span class="c1"># Row of sum is nonzero if any white pixels in row.</span>
    <span class="n">binary_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">bg_binary</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">white_blocks</span> <span class="o">=</span> <span class="n">dparray</span><span class="o">.</span><span class="n">continuous_nonzero</span><span class="p">(</span><span class="n">binary_sum</span><span class="p">)</span>
    <span class="n">top</span> <span class="o">=</span> <span class="n">white_blocks</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># Take the last row of the first block of white.</span>
    <span class="k">return</span> <span class="n">top</span><span class="o">.</span><span class="n">item</span><span class="p">()</span></div>

<div class="viewcode-block" id="export_params"><a class="viewcode-back" href="../../../dostools.image_processing.html#dosertools.image_processing.tiff_handling.export_params">[docs]</a><span class="k">def</span> <span class="nf">export_params</span><span class="p">(</span><span class="n">images_location</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">],</span> <span class="n">params_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Exports image parameters to a file to be stored with processed images.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    images_location: path-like</span>
<span class="sd">        Path in which to save the parameters.</span>
<span class="sd">    params_dict: dict</span>
<span class="sd">        Dictonary of parameters to save.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Convert the dictionary to a pandas DataFrame and save to a csv</span>
    <span class="n">folder_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">images_location</span><span class="p">)</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">images_location</span><span class="p">,</span><span class="n">folder_name</span> <span class="o">+</span> <span class="s2">&quot;_params.csv&quot;</span><span class="p">)</span>
    <span class="n">params_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">params_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Keys&#39;</span><span class="p">,</span><span class="s1">&#39;Values&#39;</span><span class="p">])</span>
    <span class="n">params_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">pass</span></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">dosertools</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../usage/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">dosertools</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2022, Rob Learsch and Red Lhota.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.4.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>